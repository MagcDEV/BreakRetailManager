@page "/inventory"
@using BreakRetailManager.Inventory.Contracts
@attribute [Authorize(Roles = "Admin,Manager")]
@inject InventoryApiClient InventoryApi

<PageTitle>Inventory</PageTitle>

<h1>Inventory</h1>

@if (!string.IsNullOrWhiteSpace(statusMessage))
{
    <div class="alert @statusCss alert-dismissible" role="alert">
        @statusMessage
        <button type="button" class="btn-close" @onclick="() => statusMessage = null"></button>
    </div>
}

<ul class="nav nav-tabs mb-4">
    <li class="nav-item">
        <button class="nav-link @(activeTab == Tab.Products ? "active" : "")" @onclick="() => activeTab = Tab.Products">Products</button>
    </li>
    <li class="nav-item">
        <button class="nav-link @(activeTab == Tab.LowStock ? "active" : "")" @onclick="ShowLowStock">Low Stock</button>
    </li>
    <li class="nav-item">
        <button class="nav-link @(activeTab == Tab.Providers ? "active" : "")" @onclick="() => activeTab = Tab.Providers">Providers</button>
    </li>
    <li class="nav-item">
        <button class="nav-link @(activeTab == Tab.AddProduct ? "active" : "")" @onclick="() => activeTab = Tab.AddProduct">+ Product</button>
    </li>
    <li class="nav-item">
        <button class="nav-link @(activeTab == Tab.AddProvider ? "active" : "")" @onclick="() => activeTab = Tab.AddProvider">+ Provider</button>
    </li>
    @if (activeTab == Tab.EditProduct)
    {
        <li class="nav-item">
            <button class="nav-link active">Edit Product</button>
        </li>
    }
    @if (activeTab == Tab.AdjustStock)
    {
        <li class="nav-item">
            <button class="nav-link active">Adjust Stock</button>
        </li>
    }
</ul>

@if (activeTab == Tab.Products)
{
    @if (products.Count == 0)
    {
        <p><em>No products found.</em></p>
    }
    else
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Barcode</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Cost</th>
                    <th>Sale Price</th>
                    <th>Stock</th>
                    <th>Reorder Lvl</th>
                    <th>Provider</th>
                    <th>Status</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var product in products)
                {
                    <tr class="@(product.IsLowStock ? "table-warning" : "")">
                        <td>@product.Barcode</td>
                        <td>@product.Name</td>
                        <td>@product.Category</td>
                        <td>@product.CostPrice.ToString("C", arsCulture)</td>
                        <td>@product.SalePrice.ToString("C", arsCulture)</td>
                        <td>@product.StockQuantity</td>
                        <td>@product.ReorderLevel</td>
                        <td>@product.ProviderName</td>
                        <td>
                            @if (product.IsLowStock)
                            {
                                <span class="badge bg-warning text-dark">Low Stock</span>
                            }
                            else
                            {
                                <span class="badge bg-success">In Stock</span>
                            }
                        </td>
                        <td class="text-nowrap">
                            <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => BeginEditProduct(product)">Edit</button>
                            <button class="btn btn-sm btn-outline-secondary" @onclick="() => BeginStockAdjust(product)">Stock</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@if (activeTab == Tab.LowStock)
{
    @if (lowStockProducts.Count == 0)
    {
        <p><em>No low stock products.</em></p>
    }
    else
    {
        <div class="alert alert-warning">@lowStockProducts.Count product(s) at or below reorder level.</div>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Barcode</th>
                    <th>Name</th>
                    <th>Stock</th>
                    <th>Reorder Lvl</th>
                    <th>Provider</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var product in lowStockProducts)
                {
                    <tr>
                        <td>@product.Barcode</td>
                        <td>@product.Name</td>
                        <td><strong>@product.StockQuantity</strong></td>
                        <td>@product.ReorderLevel</td>
                        <td>@product.ProviderName</td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@if (activeTab == Tab.Providers)
{
    @if (providers.Count == 0)
    {
        <p><em>No providers found.</em></p>
    }
    else
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Contact</th>
                    <th>Phone</th>
                    <th>Email</th>
                    <th>Address</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var provider in providers)
                {
                    <tr>
                        <td>@provider.Name</td>
                        <td>@provider.ContactName</td>
                        <td>@provider.Phone</td>
                        <td>@provider.Email</td>
                        <td>@provider.Address</td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@if (activeTab == Tab.AddProduct)
{
    <EditForm Model="productModel" OnValidSubmit="CreateProductAsync" class="mb-4">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Barcode</label>
                <InputText class="form-control" @bind-Value="productModel.Barcode" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Name</label>
                <InputText class="form-control" @bind-Value="productModel.Name" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Category</label>
                <InputText class="form-control" @bind-Value="productModel.Category" />
            </div>
            <div class="col-md-12">
                <label class="form-label">Description</label>
                <InputText class="form-control" @bind-Value="productModel.Description" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Cost Price</label>
                <InputNumber class="form-control" @bind-Value="productModel.CostPrice" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Sale Price</label>
                <InputNumber class="form-control" @bind-Value="productModel.SalePrice" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Reorder Level</label>
                <InputNumber class="form-control" @bind-Value="productModel.ReorderLevel" />
            </div>
            <div class="col-md-6">
                <label class="form-label">Provider</label>
                <InputSelect class="form-select" @bind-Value="productModel.ProviderId">
                    <option value="">-- Select provider --</option>
                    @foreach (var provider in providers)
                    {
                        <option value="@provider.Id">@provider.Name</option>
                    }
                </InputSelect>
            </div>
            <div class="col-md-6 d-flex align-items-end">
                <button class="btn btn-primary" type="submit" disabled="@isSubmitting">Create Product</button>
            </div>
        </div>
    </EditForm>
}

@if (activeTab == Tab.EditProduct)
{
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Editing: @editModel.Name</h5>
        <button class="btn btn-sm btn-outline-secondary" @onclick="() => activeTab = Tab.Products">Cancel</button>
    </div>

    <EditForm Model="editModel" OnValidSubmit="UpdateProductAsync" class="mb-4">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Barcode</label>
                <InputText class="form-control" @bind-Value="editModel.Barcode" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Name</label>
                <InputText class="form-control" @bind-Value="editModel.Name" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Category</label>
                <InputText class="form-control" @bind-Value="editModel.Category" />
            </div>
            <div class="col-md-12">
                <label class="form-label">Description</label>
                <InputText class="form-control" @bind-Value="editModel.Description" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Cost Price</label>
                <InputNumber class="form-control" @bind-Value="editModel.CostPrice" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Sale Price</label>
                <InputNumber class="form-control" @bind-Value="editModel.SalePrice" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Reorder Level</label>
                <InputNumber class="form-control" @bind-Value="editModel.ReorderLevel" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Provider</label>
                <InputSelect class="form-select" @bind-Value="editModel.ProviderId">
                    @foreach (var provider in providers)
                    {
                        <option value="@provider.Id">@provider.Name</option>
                    }
                </InputSelect>
            </div>
            <div class="col-md-12">
                <button class="btn btn-primary me-2" type="submit" disabled="@isSubmitting">Save Changes</button>
                <button class="btn btn-outline-secondary" type="button" @onclick="() => activeTab = Tab.Products">Cancel</button>
            </div>
        </div>
    </EditForm>
}

@if (activeTab == Tab.AdjustStock)
{
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Adjust Stock: @stockProductName</h5>
        <button class="btn btn-sm btn-outline-secondary" @onclick="() => activeTab = Tab.Products">Cancel</button>
    </div>

    <div class="card" style="max-width: 600px;">
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label fw-bold">Location</label>
                <select class="form-select" value="@stockLocationId" @onchange="OnStockLocationChanged">
                    <option value="">-- Select location --</option>
                    @foreach (var loc in locations)
                    {
                        <option value="@loc.Id">üìç @loc.Name</option>
                    }
                </select>
            </div>

            @if (stockLocationId == Guid.Empty)
            {
                <div class="alert alert-info">Select a location to adjust stock.</div>
            }
            else
            {
                <p class="mb-2">Current stock at location: <strong>@stockCurrentQuantity</strong></p>

                <div class="row g-3 align-items-end">
                    <div class="col">
                        <label class="form-label">Quantity to add/remove</label>
                        <input type="number" class="form-control" @bind="stockAdjustQuantity" />
                        <small class="text-muted">Use positive to add, negative to remove.</small>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-success me-1" disabled="@isSubmitting" @onclick="() => ApplyStockAdjustAsync(stockAdjustQuantity)">Apply</button>
                    </div>
                </div>

                <hr />
                <p class="mb-2"><strong>Quick adjust:</strong></p>
                <div class="btn-group me-2">
                    <button class="btn btn-outline-success btn-sm" disabled="@isSubmitting" @onclick="() => QuickAdjustAsync(1)">+1</button>
                    <button class="btn btn-outline-success btn-sm" disabled="@isSubmitting" @onclick="() => QuickAdjustAsync(5)">+5</button>
                    <button class="btn btn-outline-success btn-sm" disabled="@isSubmitting" @onclick="() => QuickAdjustAsync(10)">+10</button>
                    <button class="btn btn-outline-success btn-sm" disabled="@isSubmitting" @onclick="() => QuickAdjustAsync(50)">+50</button>
                </div>
                <div class="btn-group">
                    <button class="btn btn-outline-danger btn-sm" disabled="@isSubmitting" @onclick="() => QuickAdjustAsync(-1)">-1</button>
                    <button class="btn btn-outline-danger btn-sm" disabled="@isSubmitting" @onclick="() => QuickAdjustAsync(-5)">-5</button>
                    <button class="btn btn-outline-danger btn-sm" disabled="@isSubmitting" @onclick="() => QuickAdjustAsync(-10)">-10</button>
                    <button class="btn btn-outline-danger btn-sm" disabled="@isSubmitting" @onclick="() => QuickAdjustAsync(-50)">-50</button>
                </div>
            }
        </div>
    </div>
}

@if (activeTab == Tab.AddProvider)
{
    <EditForm Model="providerModel" OnValidSubmit="CreateProviderAsync" class="mb-4">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label">Name</label>
                <InputText class="form-control" @bind-Value="providerModel.Name" />
            </div>
            <div class="col-md-6">
                <label class="form-label">Contact Name</label>
                <InputText class="form-control" @bind-Value="providerModel.ContactName" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Phone</label>
                <InputText class="form-control" @bind-Value="providerModel.Phone" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Email</label>
                <InputText class="form-control" @bind-Value="providerModel.Email" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Address</label>
                <InputText class="form-control" @bind-Value="providerModel.Address" />
            </div>
            <div class="col-md-12">
                <button class="btn btn-primary" type="submit" disabled="@isSubmitting">Create Provider</button>
            </div>
        </div>
    </EditForm>
}

@code {
    private static readonly System.Globalization.CultureInfo arsCulture = new("es-AR");

    private readonly List<ProductDto> products = new();
    private readonly List<ProductDto> lowStockProducts = new();
    private readonly List<ProviderDto> providers = new();
    private readonly List<LocationDto> locations = new();
    private readonly CreateProductModel productModel = new();
    private readonly EditProductModel editModel = new();
    private readonly CreateProviderModel providerModel = new();

    private Tab activeTab = Tab.Products;
    private bool isSubmitting;
    private string? statusMessage;
    private string statusCss = "alert-info";

    // Stock adjustment state
    private Guid stockProductId;
    private string stockProductName = string.Empty;
    private int stockCurrentQuantity;
    private int stockAdjustQuantity;
    private Guid stockLocationId;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        products.Clear();
        products.AddRange(await InventoryApi.GetProductsAsync());

        providers.Clear();
        providers.AddRange(await InventoryApi.GetProvidersAsync());

        locations.Clear();
        locations.AddRange(await InventoryApi.GetLocationsAsync());
    }

    private async Task ShowLowStock()
    {
        activeTab = Tab.LowStock;
        lowStockProducts.Clear();
        lowStockProducts.AddRange(await InventoryApi.GetLowStockProductsAsync());
    }

    private void BeginEditProduct(ProductDto product)
    {
        editModel.Id = product.Id;
        editModel.Barcode = product.Barcode;
        editModel.Name = product.Name;
        editModel.Description = product.Description;
        editModel.Category = product.Category;
        editModel.CostPrice = product.CostPrice;
        editModel.SalePrice = product.SalePrice;
        editModel.ReorderLevel = product.ReorderLevel;
        editModel.ProviderId = product.ProviderId;
        activeTab = Tab.EditProduct;
    }

    private void BeginStockAdjust(ProductDto product)
    {
        stockProductId = product.Id;
        stockProductName = product.Name;
        stockCurrentQuantity = product.StockQuantity;
        stockAdjustQuantity = 0;
        stockLocationId = Guid.Empty;
        activeTab = Tab.AdjustStock;
    }

    private async Task OnStockLocationChanged(ChangeEventArgs e)
    {
        stockLocationId = Guid.TryParse(e.Value?.ToString(), out var id) ? id : Guid.Empty;

        if (stockLocationId != Guid.Empty)
        {
            var locationStock = await InventoryApi.GetLocationStockAsync(stockLocationId);
            var match = locationStock.FirstOrDefault(s => s.ProductId == stockProductId);
            stockCurrentQuantity = match?.Quantity ?? 0;
        }
        else
        {
            stockCurrentQuantity = 0;
        }
    }

    private async Task UpdateProductAsync()
    {
        isSubmitting = true;
        statusMessage = null;

        var request = new UpdateProductRequest(
            editModel.Barcode,
            editModel.Name,
            editModel.Description,
            editModel.Category,
            editModel.CostPrice,
            editModel.SalePrice,
            editModel.ReorderLevel,
            editModel.ProviderId);

        var updated = await InventoryApi.UpdateProductAsync(editModel.Id, request);
        if (updated is not null)
        {
            statusMessage = $"Product '{updated.Name}' updated.";
            statusCss = "alert-success";
            await LoadDataAsync();
            activeTab = Tab.Products;
        }
        else
        {
            statusMessage = "Failed to update product.";
            statusCss = "alert-danger";
        }

        isSubmitting = false;
    }

    private async Task ApplyStockAdjustAsync(int quantity)
    {
        if (stockLocationId == Guid.Empty) return;

        isSubmitting = true;
        statusMessage = null;

        var result = await InventoryApi.UpdateLocationStockAsync(stockLocationId, stockProductId, quantity);
        if (result is not null)
        {
            stockCurrentQuantity = result.Quantity;
            stockAdjustQuantity = 0;
            var locName = locations.FirstOrDefault(l => l.Id == stockLocationId)?.Name ?? "location";
            statusMessage = $"Stock for '{stockProductName}' at {locName} adjusted by {(quantity >= 0 ? "+" : "")}{quantity}. New stock: {result.Quantity}.";
            statusCss = "alert-success";
            await LoadDataAsync();
        }
        else
        {
            statusMessage = "Failed to adjust location stock.";
            statusCss = "alert-danger";
        }

        isSubmitting = false;
    }

    private async Task QuickAdjustAsync(int quantity)
    {
        stockAdjustQuantity = quantity;
        await ApplyStockAdjustAsync(quantity);
    }

    private async Task CreateProductAsync()
    {
        isSubmitting = true;
        statusMessage = null;

        var request = new CreateProductRequest(
            productModel.Barcode,
            productModel.Name,
            productModel.Description,
            productModel.Category,
            productModel.CostPrice,
            productModel.SalePrice,
            productModel.ReorderLevel,
            productModel.ProviderId);

        var created = await InventoryApi.CreateProductAsync(request);
        if (created is not null)
        {
            statusMessage = $"Product '{created.Name}' created.";
            statusCss = "alert-success";
            productModel.Reset();
            await LoadDataAsync();
            activeTab = Tab.Products;
        }
        else
        {
            statusMessage = "Failed to create product.";
            statusCss = "alert-danger";
        }

        isSubmitting = false;
    }

    private async Task CreateProviderAsync()
    {
        isSubmitting = true;
        statusMessage = null;

        var request = new CreateProviderRequest(
            providerModel.Name,
            providerModel.ContactName,
            providerModel.Phone,
            providerModel.Email,
            providerModel.Address);

        var created = await InventoryApi.CreateProviderAsync(request);
        if (created is not null)
        {
            statusMessage = $"Provider '{created.Name}' created.";
            statusCss = "alert-success";
            providerModel.Reset();
            await LoadDataAsync();
            activeTab = Tab.Providers;
        }
        else
        {
            statusMessage = "Failed to create provider.";
            statusCss = "alert-danger";
        }

        isSubmitting = false;
    }

    private enum Tab { Products, LowStock, Providers, AddProduct, AddProvider, EditProduct, AdjustStock }

    private sealed class CreateProductModel
    {
        [Required] [StringLength(100)]
        public string Barcode { get; set; } = string.Empty;

        [Required] [StringLength(200)]
        public string Name { get; set; } = string.Empty;

        [StringLength(1000)]
        public string Description { get; set; } = string.Empty;

        [StringLength(100)]
        public string Category { get; set; } = string.Empty;

        [Range(typeof(decimal), "0", "1000000")]
        public decimal CostPrice { get; set; }

        [Range(typeof(decimal), "0.01", "1000000")]
        public decimal SalePrice { get; set; }

        [Range(0, 1000000)]
        public int ReorderLevel { get; set; }

        [Required]
        public Guid ProviderId { get; set; }

        public void Reset()
        {
            Barcode = string.Empty;
            Name = string.Empty;
            Description = string.Empty;
            Category = string.Empty;
            CostPrice = 0;
            SalePrice = 0;
            ReorderLevel = 0;
            ProviderId = Guid.Empty;
        }
    }

    private sealed class EditProductModel
    {
        public Guid Id { get; set; }

        [Required] [StringLength(100)]
        public string Barcode { get; set; } = string.Empty;

        [Required] [StringLength(200)]
        public string Name { get; set; } = string.Empty;

        [StringLength(1000)]
        public string Description { get; set; } = string.Empty;

        [StringLength(100)]
        public string Category { get; set; } = string.Empty;

        [Range(typeof(decimal), "0", "1000000")]
        public decimal CostPrice { get; set; }

        [Range(typeof(decimal), "0.01", "1000000")]
        public decimal SalePrice { get; set; }

        [Range(0, 1000000)]
        public int ReorderLevel { get; set; }

        [Required]
        public Guid ProviderId { get; set; }
    }

    private sealed class CreateProviderModel
    {
        [Required] [StringLength(200)]
        public string Name { get; set; } = string.Empty;

        [StringLength(200)]
        public string ContactName { get; set; } = string.Empty;

        [StringLength(50)]
        public string Phone { get; set; } = string.Empty;

        [StringLength(200)]
        public string Email { get; set; } = string.Empty;

        [StringLength(500)]
        public string Address { get; set; } = string.Empty;

        public void Reset()
        {
            Name = string.Empty;
            ContactName = string.Empty;
            Phone = string.Empty;
            Email = string.Empty;
            Address = string.Empty;
        }
    }
}
